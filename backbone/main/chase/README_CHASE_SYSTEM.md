# Chase System - 충돌 차량 추격 시스템

## 개요
이 시스템은 CARLA 시뮬레이션에서 충돌을 일으킨 차량을 자동으로 감지하고 추격하는 통합 시스템입니다.

## 주요 기능

### 1. 객체 감지 및 이름 표시
- **바운딩 박스 감지**: 차량과 보행자의 2D/3D 바운딩 박스 감지
- **객체 이름 표시**: 차량 브랜드명 (Tesla, BMW, Audi 등)과 보행자 타입 (Young Man, Old Woman 등) 표시
- **실시간 거리 정보**: 각 객체까지의 거리 표시

### 2. 충돌 감지
- **보행자 충돌 감지**: 보행자가 누워진 상태를 다중 조건으로 감지
  - 가로세로 비율 급격한 변화 (서서 있던 사람이 누워짐)
  - 현재 가로가 세로보다 1.5배 이상 (누워진 상태)
  - 높이 급격한 감소 (쓰러짐)
  - 바운딩 박스 크기 급격한 변화
- **충돌 점수 계산**: 4가지 조건 중 2개 이상 만족 시 충돌로 판단
- **실시간 충돌 알림**: 충돌 발생 시 즉시 알림

### 3. 충돌 차량 추적
- **자동 타겟 선택**: 충돌 지점에서 가장 가까운 차량을 자동으로 선택
- **지속적 추적**: 차량이 시야에서 벗어나도 위치 예측을 통한 추적 유지
- **속도 및 경로 예측**: 차량의 이동 패턴을 분석하여 미래 위치 예측

### 4. 추격 행동
- **다단계 추격**: 탐색 → 접근 → 추격 → 차단 → 유지 단계별 행동
- **지능적 경로 계획**: 타겟의 예상 경로를 분석하여 최적의 추격 경로 생성
- **안전 제어**: 비상 상황 감지 시 자동 정지

## 모듈 구조

```
chase/
├── perception/           # 감지 모듈
│   ├── bounding_box_detector.py      # 바운딩 박스 감지
│   ├── collision_detector.py         # 충돌 감지
│   └── collision_vehicle_tracker.py  # 충돌 차량 추적
├── planning/             # 계획 모듈
│   ├── behavior_planner.py           # 행동 계획
│   └── chase_planner.py              # 추격 계획
├── control/              # 제어 모듈
│   ├── vehicle_controller.py         # 차량 제어
│   ├── pid_controller.py             # PID 제어
│   └── actuator.py                   # 액추에이터
└── chase_system.py       # 통합 시스템
```

## 사용법

### 1. 기본 실행
```bash
# 자동 추격 시스템 (충돌 감지 시 자동 추격)
./run_auto_chase_vehicle.sh

# 또는 기존 스크립트 사용
./run_chase_vehicle.sh
```

### 2. 제어 방법
- **ESC**: 종료
- **자동 모드**: 충돌 감지 시 자동으로 추격 시작
- **수동 모드**: 향상된 수동 제어 (선택사항)
  - **WASD**: 수동 차량 제어
  - **C**: 추격 모드 토글 (수동 ↔ 추격)
  - **R**: 추격 시스템 리셋
  - **H**: HUD 토글

### 3. 자동 추격 동작
1. **대기 모드**: 충돌 감지까지 대기
2. **충돌 감지**: 보행자 충돌 감지 시 자동으로 가장 가까운 차량 선택
3. **자동 추격**: 선택된 차량을 자동으로 추격
4. **타겟 손실**: 타겟이 손실되면 탐색 모드로 전환하여 재탐지 시도

## 설정 파라미터

### 추격 거리 설정
```python
# 추격 시스템 파라미터 (고속 추격 설정)
chase_system.set_chase_parameters(
    follow_distance=20.0,      # 추격 거리 (m) - 더 넓게
    approach_distance=60.0,    # 접근 거리 (m) - 더 넓게
    max_speed=30.0,           # 최대 속도 (m/s) - 108km/h
    update_interval=0.05      # 업데이트 간격 (s) - 50ms (더 빠른 반응)
)
```

### 충돌 감지 임계값
```python
# 충돌 감지기 파라미터 (다중 조건 기반)
collision_conditions = {
    'ratio_change_threshold': 0.3,     # 가로세로 비율 변화 (30% 이상)
    'lying_down_threshold': 1.5,       # 누워진 상태 (가로가 세로의 1.5배 이상)
    'height_drop_threshold': 0.5,      # 높이 하락 (0.5m 이상)
    'size_change_threshold': 0.4,      # 크기 변화 (40% 이상)
    'min_conditions': 2                # 최소 조건 수 (2개 이상 만족 시 충돌)
}
```

## 상태 모니터링

### 추격 상태
- **IDLE**: 대기 상태
- **SEARCHING**: 타겟 탐색
- **APPROACHING**: 타겟 접근
- **FOLLOWING**: 타겟 추격
- **INTERCEPTING**: 타겟 차단
- **EMERGENCY**: 비상 정지

### 실시간 정보
- 타겟까지의 거리
- 현재 추격 속도
- 추격 지속 시간
- 감지된 객체 수
- 충돌 이벤트 수

## 성능 최적화

### 1. 업데이트 주기 조정
```python
# 빠른 반응이 필요한 경우
update_interval = 0.05  # 50ms

# 안정성이 중요한 경우
update_interval = 0.2   # 200ms
```

### 2. 감지 거리 제한
```python
# 감지 최대 거리 설정
max_detection_distance = 100.0  # 100m
```

### 3. 추적 타임아웃 설정
```python
# 타겟 손실 타임아웃
track_timeout = 5.0  # 5초
```

## 문제 해결

### 1. 타겟 추적 실패
- 카메라 위치 조정
- 감지 거리 증가
- 추적 타임아웃 연장

### 2. 추격 성능 저하
- 업데이트 주기 조정
- 제어 파라미터 튜닝
- 차량 속도 제한

### 3. 충돌 감지 오류
- 임계값 조정
- 히스토리 크기 증가
- 감지 알고리즘 개선

## 확장 가능성

### 1. 추가 감지 기능
- YOLO 객체 감지 통합
- LiDAR 센서 데이터 활용
- 다중 카메라 시스템

### 2. 고급 추격 알고리즘
- 칼만 필터 기반 추적
- 머신러닝 예측 모델
- 협력 추격 시스템

### 3. 통신 시스템
- Zenoh 기반 분산 추격
- 다중 차량 협력
- 실시간 데이터 공유

## 라이선스
이 프로젝트는 CARLA 시뮬레이션 환경에서 사용되며, CARLA의 라이선스 정책을 따릅니다.
